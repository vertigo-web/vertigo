[config]
default_to_workspace = false


[tasks.vertigo-test]
script = [
    "cargo test -p vertigo --all-features"
]

[tasks.vertigo-test-single]
script = [
    "cargo test -p vertigo --all-features -- --test-threads=1"
]

# Run clippy for wasm32 target

[tasks.clippy-wasm32]
dependencies = [ "wasm32-target" ]
command = "cargo"
args = [
    "clippy",
    "--all-features",
    "--target", "wasm32-unknown-unknown",
    "-p", "vertigo",
    "-p", "vertigo-macro",
    "-p", "vertigo-demo",
    "-p", "vertigo-example-counter",
    "-p", "vertigo-example-router"
]


# Demo tasks

[tasks.opt_try]
ignore_errors = true
script = [
    "wasm-opt -Os --strip-debug -o ./demo/build/vertigo_demo.wasm ${CARGO_MAKE_CRATE_TARGET_DIRECTORY}/wasm32-unknown-unknown/release/vertigo_demo.wasm",
]

[tasks.opt_catch.condition]
files_not_exist = ["./demo/build/vertigo_demo.wasm"]
[tasks.opt_catch]
script = [
    "echo \" \\033[31m You do not have a command \"wasm-opt\" in your system  \\033[0m \" >&2",
    "echo \" \\033[31m You need to install Binaryen: https://github.com/WebAssembly/binaryen \\033[0m \" >&2",
    "cp ${CARGO_MAKE_CRATE_TARGET_DIRECTORY}/wasm32-unknown-unknown/release/vertigo_demo.wasm ./demo/build/vertigo_demo.wasm",
]


[tasks.demo-build]
dependencies = [ "wasm32-target", "demo-clean" ]
script = [
    "mkdir -p demo/build",
    "cargo build -p vertigo-demo --release --target wasm32-unknown-unknown",
    "cp ${CARGO_MAKE_CRATE_TARGET_DIRECTORY}/wasm32-unknown-unknown/release/wasm_run.js ./demo/build/wasm_run.js",
    "cargo make opt_try",
    "cargo make opt_catch",
    "cp ./demo/app/index.html ./demo/build",
]

[tasks.demo-serve-old]
install_crate = { crate_name = "basic-http-server", binary = "basic-http-server", test_arg = ["--version"] }
command = "basic-http-server"
args = [ "--addr", "127.0.0.1:3000", "./build" ]

[tasks.demo-serve]
command = "cargo"
args = [ "run", "--bin", "vertigo-demo-server" ]

[tasks.demo-start]
dependencies = [
    "demo-build",
    "demo-serve"
]

[tasks.demo-watch]
command = "cargo"
args = [ "watch", "--watch", "./demo/app", "--watch", "crates", "--delay", "0.5", "-x", "make demo-start" ]

[tasks.demo-clean]
script = [
    "rm -Rf demo/build"
]

# Examples tasks

[env]
EXAMPLES = "counter router"

# Run without arguments to build all examples; provide example name to build only this particular example
[tasks.examples-build]
dependencies = [ "wasm32-target" ]
script = '''
    NAME=${@}
    if [ "$NAME" = "" ]; then
        for name in ${EXAMPLES}; do
            cargo make examples-build ${name}
        done
    else
        mkdir -p examples/build/${NAME}
        cargo build -p vertigo-example-${NAME} --release --target wasm32-unknown-unknown
        cp ${CARGO_MAKE_CRATE_TARGET_DIRECTORY}/wasm32-unknown-unknown/release/wasm_run.js ./examples/build/${NAME}/wasm_run.js
        # wasm-pack build examples/${NAME} --no-typescript --target web --out-dir ../build/${NAME} --out-name app --release
        wasm-opt -Os --strip-debug -o ./examples/build/${NAME}/vertigo_example_${NAME}.wasm ${CARGO_MAKE_CRATE_TARGET_DIRECTORY}/wasm32-unknown-unknown/release/vertigo_example_${NAME}.wasm
        # cargo make opt_try
        # cargo make opt_catch
        # cp ./demo/app/index.html ./demo/build
        cp examples/${NAME}/index.html examples/build/${NAME}
    fi
'''

[tasks.examples-clean]
command = "rm"
args = [ "-rf", "examples/build" ]


# Dependencies

[tasks.wasm32-target]
install_script = '''
    if [ "$(rustup target list | grep wasm32-unknown-unknown | grep installed)" = "" ];
    then
        rustup target add wasm32-unknown-unknown;
    fi
'''

# JavaScript dev builds

[tasks.build-js-run-ts]
command = "npx"
args = [ "-p", "typescript", "tsc",
    "--strict",
    "--noUnusedLocals", "--noUnusedParameters", "--noUncheckedIndexedAccess",
    "--noEmitOnError",
    "--lib", "es6,dom,esnext",
    "--target", "esnext",
    "--module", "es6",
    "--outDir", "crates/vertigo/src/driver_module/src_js_build",
    "crates/vertigo/src/driver_module/src_js/index.ts",
]

[tasks.build-js]
dependencies = [ "build-js-run-ts" ]
script = [
    "npx rollup crates/vertigo/src/driver_module/src_js_build/index.js --file crates/vertigo/src/driver_module/wasm_run.js",
    "rm -rf crates/vertigo/src/driver_module/src_js_build",
]

[tasks.lint]
script = "cargo run --bin lint-project"
