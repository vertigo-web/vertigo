[config]
default_to_workspace = false


# Run clippy for wasm32 target

[tasks.clippy-wasm32]
dependencies = [ "wasm32-target" ]
command = "cargo"
args = [
    "clippy", "--all-features", "--target", "wasm32-unknown-unknown",
    "-p", "vertigo", "-p", "vertigo-macro", "-p", "vertigo-browserdriver",
    "-p", "vertigo-demo", "-p", "vertigo-example-counter", "-p", "vertigo-example-router"
]


# Demo tasks

[tasks.demo-build]
dependencies = [ "wasm32-target" ]
install_crate = { crate_name = "wasm-pack", binary = "wasm-pack", test_arg = ["--version"] }
script = [
    "wasm-pack build demo/app --no-typescript --target web --out-dir ../build --out-name demo --release",
    "cp ./demo/app/index.html ./demo/build",
    "rm ./demo/build/.gitignore",
    "rm ./demo/build/package.json",
]

[tasks.demo-serve-old]
install_crate = { crate_name = "basic-http-server", binary = "basic-http-server", test_arg = ["--version"] }
command = "basic-http-server"
args = [ "--addr", "127.0.0.1:3000", "./build" ]

[tasks.demo-serve]
command = "cargo"
args = [ "run", "--bin", "vertigo-demo-server" ]

[tasks.demo-start]
dependencies = [
    "demo-clean",
    "demo-build",
    "demo-serve"
]

[tasks.demo-watch]
command = "cargo"
args = [ "watch", "--watch", "./demo/app", "--watch", "crates", "--delay", "0.5", "-x", "make demo-start" ]

[tasks.demo-clean]
command = "rm"
args = [ "-rf", "demo/build" ]


# Examples tasks

[env]
EXAMPLES = "counter router"

# Run without arguments to build all examples; provide example name to build only this particular example
[tasks.examples-build]
dependencies = [ "wasm32-target" ]
install_crate = { crate_name = "wasm-pack", binary = "wasm-pack", test_arg = ["--version"] }
script = '''
    NAME=${@}
    if [ "$NAME" = "" ]; then
        for name in ${EXAMPLES}; do
            cargo make examples-build ${name}
        done
    else
        wasm-pack build examples/${NAME} --no-typescript --target web --out-dir ../build/${NAME} --out-name app --release
        cp examples/${NAME}/index.html examples/build/${NAME}
        rm examples/build/${NAME}/.gitignore
        rm examples/build/${NAME}/package.json
    fi
'''

[tasks.examples-clean]
command = "rm"
args = [ "-rf", "examples/build" ]


# Dependencies

[tasks.wasm32-target]
install_script = '''
    if [ "$(rustup target list | grep wasm32-unknown-unknown | grep installed)" = "" ];
    then
        rustup target add wasm32-unknown-unknown;
    fi
'''

[tasks.upgrade-wasm-pack]
script = [
    "cargo install --force wasm-pack",
    "cargo clean",
]


# JavaScript dev builds

[tasks.build-js-dom]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/dom/js_dom.ts"]

[tasks.build-js-fetch]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/fetch/js_fetch.ts"]

[tasks.build-js-hashrouter]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/hashrouter/js_hashrouter.ts"]

[tasks.build-js-interval]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/interval/js_interval.ts"]

[tasks.build-js-instant]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/instant/js_instant"]

[tasks.build-js-websocket]
command = "npx"
args = [ "-p", "typescript", "tsc", "--strict", "--noUncheckedIndexedAccess", "--noEmitOnError", "--lib", "esnext,dom,es6", "--target", "esnext", "--module", "es6", "crates/vertigo-browserdriver/src/modules/websocket/js_websocket.ts"]


[tasks.build-js]
dependencies = [
    "build-js-dom",
    "build-js-fetch",
    "build-js-hashrouter",
    "build-js-interval",
    "build-js-instant",
    "build-js-websocket"
]
command = "echo"
args = [ "build-js complete"]
