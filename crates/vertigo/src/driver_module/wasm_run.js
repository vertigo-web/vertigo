"use strict";const e=1,t=2,o=3,r=4,s=5,n=6,i=7,a=8,l=9,c=10,u=11,h=12,d=13,f=14;var m;!function(s){s.isString=e=>"string"==typeof e,s.isStringOrNull=e=>null===e||"string"==typeof e,s.isNumber=o=>"object"==typeof o&&null!==o&&"type"in o&&(o.type===t||o.type===e),s.isBigInt=e=>"object"==typeof e&&null!==e&&"type"in e&&(e.type===r||e.type===o),s.isJsObject=e=>null!==e&&"object"==typeof e&&"type"in e&&e.type===d,s.isJson=e=>null!==e&&"object"==typeof e&&"type"in e&&e.type===f}(m||(m={}));const g=e=>{throw Error("assert never")},p=new TextDecoder("utf-8"),y=new TextEncoder;class v{constructor(e,t){this.getUint8Memory=e,this.pointer=0,this.ptr=Number(t>>32n),this.size=Number(t%2n**32n),this.dataView=new DataView(this.getUint8Memory().buffer,this.ptr,this.size)}getByte(){const e=this.dataView.getUint8(this.pointer);return this.pointer+=1,e}setByte(e){this.dataView.setUint8(this.pointer,e),this.pointer+=1}getU16(){const e=this.dataView.getUint16(this.pointer);return this.pointer+=2,e}setU16(e){this.dataView.setUint16(this.pointer,e),this.pointer+=2}getU32(){const e=this.dataView.getUint32(this.pointer);return this.pointer+=4,e}setU32(e){this.dataView.setUint32(this.pointer,e),this.pointer+=4}getI32(){const e=this.dataView.getInt32(this.pointer);return this.pointer+=4,e}setI32(e){this.dataView.setInt32(this.pointer,e),this.pointer+=4}getU64(){const e=this.dataView.getBigUint64(this.pointer);return this.pointer+=8,e}setU64(e){this.dataView.setBigUint64(this.pointer,e),this.pointer+=8}getI64(){const e=this.dataView.getBigInt64(this.pointer);return this.pointer+=8,e}setI64(e){this.dataView.setBigInt64(this.pointer,e),this.pointer+=8}getF64(){const e=this.dataView.getFloat64(this.pointer);return this.pointer+=8,e}setF64(e){this.dataView.setFloat64(this.pointer,e),this.pointer+=8}getBuffer(){const e=this.getU32(),t=this.getUint8Memory().subarray(this.ptr+this.pointer,this.ptr+this.pointer+e);return this.pointer+=e,t}setBuffer(e){const t=e.length;this.setU32(t);this.getUint8Memory().subarray(this.ptr+this.pointer,this.ptr+this.pointer+t).set(e),this.pointer+=t}getString(){return p.decode(this.getBuffer())}setString(e){const t=y.encode(e);this.setBuffer(t)}getSavedSize(){return this.pointer}}const w=e=>(new TextEncoder).encode(e).length,b=1,_=2,k=3,L=4,x=5,S=6,E=7,C=e=>{if("boolean"==typeof e)return 1;if(null===e)return 1;if("string"==typeof e)return 5+w(e);if(Array.isArray(e)){let t=5;for(const o of e)t+=C(o);return t}if("number"==typeof e)return 9;let t=3;for(const[o,r]of Object.entries(e))t+=4+w(o),t+=C(r);return t},T=e=>{const t=e.getByte();if(t===b)return!0;if(t===_)return!1;if(t===k)return null;if(t===L)return e.getString();if(t===x)return e.getF64();if(t===S){const t=[],o=e.getU32();for(let r=0;r<o;r++)t.push(T(e));return t}const o={},r=e.getU16();for(let t=0;t<r;t++){const t=e.getString(),r=T(e);o[t]=r}return o},A=(e,t)=>{if(!0===e)return void t.setByte(b);if(!1===e)return void t.setByte(_);if(null===e)return void t.setByte(k);if("string"==typeof e)return t.setByte(L),void t.setString(e);if("number"==typeof e)return t.setByte(x),void t.setF64(e);if(Array.isArray(e)){t.setByte(S),t.setU32(e.length);for(const o of e)A(o,t);return}const o=[];for(const[t,r]of Object.entries(e))o.push([t,r]);t.setByte(E),t.setU16(o.length);for(const[e,r]of o)t.setString(e),A(r,t)},B=m=>{const g=m.getByte();if(g===e)return{type:e,value:m.getU32()};if(g===t)return{type:t,value:m.getI32()};if(g===o)return{type:o,value:m.getU64()};if(g===r)return{type:r,value:m.getI64()};if(g===s)return{type:s,value:m.getF64()};if(g===n)return!0;if(g===i)return!1;if(g===a)return null;if(g!==l){if(g===c)return m.getBuffer();if(g===u)return m.getString();if(g===h){const e=[],t=m.getU32();for(let o=0;o<t;o++)e.push(B(m));return e}if(g===d){const e={},t=m.getU16();for(let o=0;o<t;o++){const t=m.getString(),o=B(m);e[t]=o}return{type:d,value:e}}if(g===f){const e=T(m);return{type:f,value:e}}throw console.error("typeParam",g),Error("Invalid branch")}},W=n=>{if(!0===n||!1===n||null==n)return 1;if(m.isString(n))return 5+w(n);if(Array.isArray(n)){let e=5;for(const t of n)e+=W(t);return e}if(n instanceof Uint8Array)return 5+n.length;if(n.type===t||n.type===e)return 5;if(n.type===r||n.type===o||n.type==s)return 9;if(n.type===d){let e=3;for(const[t,o]of Object.entries(n.value))e+=4+w(t),e+=W(o);return e}return n.type===f?1+C(n.value):g()},I=(p,y)=>{if(!0!==p)if(!1!==p)if(null!==p)if(void 0!==p){if(p instanceof Uint8Array)return y.setByte(c),void y.setBuffer(p);if(m.isString(p))return y.setByte(u),void y.setString(p);if(!Array.isArray(p)){if(p.type===e)return y.setByte(e),void y.setU32(p.value);if(p.type===t)return y.setByte(t),void y.setI32(p.value);if(p.type===o)return y.setByte(o),void y.setU64(p.value);if(p.type===r)return y.setByte(r),void y.setI64(p.value);if(p.type===s)return y.setByte(s),void y.setF64(p.value);if(p.type===d){const e=[];for(const[t,o]of Object.entries(p.value))e.push([t,o]);y.setByte(d),y.setU16(e.length);for(const[t,o]of e)y.setString(t),I(o,y);return}return p.type===f?(y.setByte(f),void A(p.value,y)):g()}y.setByte(h),y.setU32(p.length);for(const e of p)I(e,y)}else y.setByte(l);else y.setByte(a);else y.setByte(i);else y.setByte(n)},U=n=>{if(!0===n)return!0;if(!1===n)return!1;if(null===n)return null;if(void 0!==n){if(n instanceof Uint8Array)return n;if(m.isString(n))return n;if(Array.isArray(n)){const e=[];for(const t of n)e.push(U(t));return e}if(n.type===e||n.type===t)return n.value;if(n.type===o||n.type===r||n.type===s)return n.value;if(n.type===d){const e={};for(const[t,o]of Object.entries(n.value))e[t]=U(o);return e}return n.type===f?n.value:g()}},M=e=>{if("string"==typeof e)return e;if(!0===e||!1===e||null==e)return e;if("number"==typeof e)return e===(0|e)?-2147483648<=e&&e<2**31?{type:t,value:e}:{type:r,value:BigInt(e)}:{type:s,value:e};if("bigint"==typeof e)return{type:r,value:e};if(e instanceof Uint8Array)return e;if("object"==typeof e){try{const t=N(e);return{type:f,value:t}}catch(e){}const t={};for(const[o,r]of Object.entries(e))t[o]=M(r);return{type:d,value:t}}if(Array.isArray(e))try{const t=e.map(N);return{type:f,value:t}}catch(t){return e.map(M)}throw console.warn("convertToJsValue",e),Error("It is not possible to convert this data to JsValue")},N=e=>{if("boolean"==typeof e||null===e||"number"==typeof e||"string"==typeof e)return e;if(Array.isArray(e))return e.map(N);if("object"==typeof e){const t={};for(const[o,r]of Object.entries(e))t[o]=N(r);return t}throw console.warn("convertToJsJson",e),Error("It is not possible to convert this data to JsJson")},$=async(e,t)=>{const o=await(async(e,t)=>{if("function"==typeof WebAssembly.instantiateStreaming){const o=fetch(e);try{return await WebAssembly.instantiateStreaming(o,t)}catch(e){console.warn("`WebAssembly.instantiateStreaming` failed. This could happen if your server does not serve wasm with `application/wasm` MIME type, but check the original error too. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}}console.info("fetchModule by WebAssembly.instantiate");const o=await fetch(e),r=await o.arrayBuffer();return await WebAssembly.instantiate(r,t)})(e,t);let r=new Uint8Array(1);const s=()=>{if(o.instance.exports.memory instanceof WebAssembly.Memory)return r.buffer!==o.instance.exports.memory.buffer&&(r=new Uint8Array(o.instance.exports.memory.buffer)),r;throw Error("Missing memory")},n=o.instance.exports,i=e=>{if(0n===e)return;const t=((e,t)=>{try{const o=new v(e,t);return B(o)}catch(e){return console.error(e),[]}})(s,e);return n.vertigo_export_free_block(e),t},a=e=>((e,t,o)=>{if(void 0===o)return 0n;const r=W(o),s=t(r),n=new v(e,s);if(I(o,n),r!==n.getSavedSize())throw console.error({size:r,savedSize:n.getSavedSize()}),Error("Mismatch between calculated and recorded size");return s})(s,n.vertigo_export_alloc_block,e);return{exports:n,decodeArgumentsLong:i,getUint8Memory:s,wasm_callback:(e,t)=>{const o=a(t);let r=n.vertigo_export_wasm_callback(e,o);return i(r)},wasm_command:e=>{const t=a({type:14,value:e});let o=n.vertigo_export_wasm_command(t);const r=i(o);if(m.isJson(r))return r.value;throw Error("Json expected")},valueSaveToBufferLong:a}};class R{constructor(){this.data=new Map,this.initNodes=[...this.get_root_head().childNodes,...this.get_root_body().childNodes],this.style=document.createElement("style"),this.get_root_head().appendChild(this.style)}get_root_html(){return document.documentElement}get_root_head(){return document.head}get_root_body(){return document.body}set(e,t){1===e||2===e||3===e||this.data.set(e,t)}get_any_option(e){return 1===e?this.get_root_html():2===e?this.get_root_head():3===e?this.get_root_body():this.data.get(e)}get_any(e,t){const o=this.get_any_option(t);if(void 0===o)throw Error(`${e} -> item not found=${t}`);return o}get(e,t){const o=this.get_any_option(t);if(void 0===o)throw new Error(`${e}->get: Item id not found = ${t}`);return o}get_node_element(e,t){const o=this.get(e,t);if(o instanceof HTMLElement)return o;throw Error(`Expected id=${t} as HTMLElement`)}get_node(e,t){const o=this.get(e,t);if(o instanceof Element)return o;throw Error(`Expected id=${t} as Element`)}get_text(e,t){const o=this.get(e,t);if(o instanceof Text)return o;throw Error(`Expected id=${t} as Text`)}get_comment(e,t){const o=this.get(e,t);if(o instanceof Comment)return o;throw Error(`Expected id=${t} as Comment`)}delete(e,t){const o=this.get_any_option(t);if(this.data.delete(t),void 0===o)throw new Error(`${e}->delete: Item id not found = ${t}`);return o}insert_css(e,t){if(null!==e){const o=document.createTextNode(`\n${e} { ${t} }`);this.style.appendChild(o)}else{const e=document.createTextNode(`\n${t}`);this.style.appendChild(e)}}removeInitNodes(){const e=this.initNodes;if(this.initNodes=null,null!==e)for(const t of e)t.remove()}insert_before(e,t,o){const r=this.get("insert_before",e),s=this.get_any("insert_before child",t);if(null==o)r.insertBefore(s,null);else{const e=this.get_any("insert_before ref",o);r.insertBefore(s,e)}r===this.get_root_head()&&this.get_root_head().appendChild(this.style)}}class j{constructor(e,t){this.dom_bulk_update=e=>{const t=new Set;for(const o of e){try{this.bulk_update_command(o)}catch(e){console.error("bulk_update - item",e,o)}"set_attr"===o.type&&"autofocus"===o.name.toLocaleLowerCase()&&t.add(o.id)}t.size>0&&setTimeout(()=>{for(const e of t){this.nodes.get_node_element(`set focus ${e}`,e).focus()}},0),this.nodes.removeInitNodes()},this.appLocation=e,this.getWasm=t,this.nodes=new R,this.callbacks=new Map,document.addEventListener("dragover",e=>{e.preventDefault()})}debugNodes(...e){const t={};for(const o of e){const e=this.nodes.get_any_option(o);t[o]=e}console.info("debug nodes",t)}create_node(e,t){const o=(e=>"path"==e||"svg"==e?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e))(t);this.nodes.set(e,o),"a"===t.toLowerCase().trim()&&o.addEventListener("click",e=>{let t=o.getAttribute("href");null!==t&&(t.startsWith("#")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("//")||(e.preventDefault(),this.appLocation.set("History","Push",t),window.scrollTo(0,0)))})}set_attribute(e,t,o){const r=this.nodes.get_node("set_attribute",e);if(r.setAttribute(t,o),"value"==t){if(r instanceof HTMLInputElement)return void(r.value=o);if(r instanceof HTMLTextAreaElement)return r.value=o,void(r.defaultValue=o)}}remove_attribute(e,t){const o=this.nodes.get_node("remove_attribute",e);if(o.removeAttribute(t),"value"==t){if(o instanceof HTMLInputElement)return void(o.value="");if(o instanceof HTMLTextAreaElement)return o.value="",void(o.defaultValue="")}}remove_node(e){this.nodes.delete("remove_node",e).remove()}create_text(e,t){const o=document.createTextNode(t);this.nodes.set(e,o)}remove_text(e){this.nodes.delete("remove_node",e).remove()}update_text(e,t){this.nodes.get_text("set_attribute",e).textContent=t}callback_click(e,t){e.preventDefault();let o=this.getWasm().wasm_callback(t,void 0);if(m.isJsObject(o)){let t=o.value;null!==t&&(!0===t.stop_propagation&&e.stopPropagation(),!0===t.prevent_default&&e.preventDefault())}}callback_submit(e,t){e.preventDefault(),this.getWasm().wasm_callback(t,void 0)}callback_input(e,t){const o=e.target;o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement?this.getWasm().wasm_callback(t,o.value):console.warn("event input ignore",o)}callback_change(e,t){const o=e.target;o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement||o instanceof HTMLSelectElement?this.getWasm().wasm_callback(t,o.value):console.warn("event input ignore",o)}callback_blur(e,t){this.getWasm().wasm_callback(t,void 0)}callback_mousedown(e,t){this.getWasm().wasm_callback(t,void 0)&&e.preventDefault()}callback_mouseup(e,t){this.getWasm().wasm_callback(t,void 0)&&e.preventDefault()}callback_mouseenter(e,t){this.getWasm().wasm_callback(t,void 0)}callback_mouseleave(e,t){this.getWasm().wasm_callback(t,void 0)}callback_drop(e,t){if(e.preventDefault(),e instanceof DragEvent)if(null===e.dataTransfer)console.error("dom -> drop -> dataTransfer null");else{const o=[];for(let t=0;t<e.dataTransfer.items.length;t++){const r=e.dataTransfer.items[t];if(void 0===r)console.error("dom -> drop -> item - undefined");else{const e=r.getAsFile();null===e?console.error(`dom -> drop -> index:${t} -> It's not a file`):o.push(e.arrayBuffer().then(t=>({name:e.name,data:new Uint8Array(t)})))}}o.length?Promise.all(o).then(e=>{const o=[];for(const t of e)o.push([t.name,t.data]);this.getWasm().wasm_callback(t,[o])}).catch(e=>{console.error("callback_drop -> promise.all -> ",e)}):console.error("No files to send")}else console.warn("event drop ignore",e)}callback_keydown(e,t){if(e instanceof KeyboardEvent){return void(!0===this.getWasm().wasm_callback(t,[e.key,e.code,e.altKey,e.ctrlKey,e.shiftKey,e.metaKey])&&(e.preventDefault(),e.stopPropagation()))}console.warn("keydown ignore",e)}callback_load(e,t){e.preventDefault(),this.getWasm().wasm_callback(t,void 0)}callback_add(e,t,o){const r=e=>"click"===t?this.callback_click(e,o):"submit"===t?this.callback_submit(e,o):"input"===t?this.callback_input(e,o):"change"===t?this.callback_change(e,o):"blur"===t?this.callback_blur(e,o):"mousedown"===t?this.callback_mousedown(e,o):"mouseup"===t?this.callback_mouseup(e,o):"mouseenter"===t?this.callback_mouseenter(e,o):"mouseleave"===t?this.callback_mouseleave(e,o):"keydown"===t||"hook_keydown"===t?this.callback_keydown(e,o):"drop"===t?this.callback_drop(e,o):"load"===t?this.callback_load(e,o):void console.error(`No support for the event ${t}`);if(this.callbacks.has(o))console.error(`There was already a callback added with the callback_id=${o}`);else if(this.callbacks.set(o,r),"hook_keydown"===t)document.addEventListener("keydown",r,!1);else{this.nodes.get("callback_add",e).addEventListener(t,r,!1)}}callback_remove(e,t,o){const r=this.callbacks.get(o);if(this.callbacks.delete(o),void 0!==r)if("hook_keydown"===t)document.removeEventListener("keydown",r);else{this.nodes.get("callback_remove",e).removeEventListener(t,r)}else console.error(`The callback is missing with the id=${o}`)}bulk_update_command(e){if("remove_node"!==e.type)if("insert_before"!==e.type)if("create_node"!==e.type)if("create_text"!==e.type)if("update_text"!==e.type)if("set_attr"!==e.type)if("remove_attr"!==e.type)if("remove_text"!==e.type)if("insert_css"!==e.type){if("create_comment"===e.type){const t=document.createComment(e.value);return void this.nodes.set(e.id,t)}if("remove_comment"===e.type){return void this.nodes.delete("remove_comment",e.id).remove()}if("callback_add"!==e.type){if("callback_remove"!==e.type)return(e=>{throw console.error(e),Error("unknown command")})(e);this.callback_remove(e.id,e.event_name,BigInt(e.callback_id))}else this.callback_add(e.id,e.event_name,BigInt(e.callback_id))}else this.nodes.insert_css(e.selector,e.value);else this.remove_text(e.id);else this.remove_attribute(e.id,e.name);else this.set_attribute(e.id,e.name,e.value);else this.update_text(e.id,e.value);else this.create_text(e.id,e.value);else this.create_node(e.id,e.name);else this.nodes.insert_before(e.parent,e.child,null===e.ref_id?null:e.ref_id);else this.remove_node(e.id)}}class J{constructor(e,t){this.dom=new j(t,e)}}class V{constructor(e,t,o){this.api=e,this.nodes=t,this.wsk=o}getByProperty(e,t){try{const e=this.wsk[t];return new V(this.api,this.nodes,e)}catch(o){return console.error("A problem with get",{path:e,property:t,error:o}),null}}toValue(){return M(this.wsk)}next(e,t){if(Array.isArray(t)){const[o,...r]=t;return"api"===o?this.nextApi(e,r):"root"===o?this.nextRoot(e,r):"get"===o?this.nextGet(e,r):"set"===o?this.nextSet(e,r):"call"===o?this.nextCall(e,r):"get_props"===o?this.nextGetProps(e,r):(console.error("JsNode.next - wrong commandName",o),null)}return console.error("JsNode.next - array was expected",{path:e,command:t}),null}nextApi(e,t){return 0===t.length?new V(this.api,this.nodes,this.api):(console.error("nextApi: wrong parameter",{path:e,args:t}),null)}nextRoot(e,t){const[o,...r]=t;if(m.isString(o)&&0===r.length)return"window"===o?new V(this.api,this.nodes,window):"document"===o?new V(this.api,this.nodes,document):(console.error(`JsNode.nextRoot: Global name not found -> ${o}`,{path:e,args:t}),null);if((m.isNumber(o)||m.isBigInt(o))&&0===r.length){const r=Number(o.value),s=this.nodes.get_any_option(r);return void 0!==s?new V(this.api,this.nodes,s):(console.error(`JsNode.nextRoot: No node with id=${r}`,{path:e,args:t}),null)}return console.error("JsNode.nextRoot: wrong parameter",{path:e,args:t}),null}nextGet(e,t){const[o,...r]=t;return m.isString(o)&&0===r.length?this.getByProperty(e,o):(console.error("JsNode.nextGet - wrong parameters",{path:e,args:t}),null)}nextSet(e,t){const[o,r,...s]=t;if(m.isString(o)&&0===s.length)try{return this.wsk[o]=U(r),new V(this.api,this.nodes,void 0)}catch(t){return console.error("A problem with set",{path:e,property:o,error:t}),null}return console.error("JsNode.nextSet - wrong parameters",{path:e,args:t}),null}nextCall(e,t){const[o,...r]=t;if(m.isString(o))try{let e=r.map(U);const t=this.wsk[o](...e);return new V(this.api,this.nodes,t)}catch(t){return console.error("A problem with call",{path:e,property:o,error:t}),null}return console.error("JsNode.nextCall - wrong parameters",{path:e,args:t}),null}nextGetProps(e,t){const o={};for(const r of t){if(!m.isString(r))return console.error("JsNode.nextGetProps - wrong parameters",{path:e,args:t,property:r}),null;{const t=this.getByProperty(e,r);if(null===t)return null;o[r]=t.toValue()}}return new V(this.api,this.nodes,o)}}class D{constructor(){this.events=new Set}on(e){let t=!0;const o=o=>{t&&e(o)};return this.events.add(o),()=>{t=!1,this.events.delete(o)}}trigger(e){const t=Array.from(this.events.values());for(const o of t)try{o(e)}catch(e){console.error(e)}}get size(){return this.events.size}}class G{constructor(){this.promiseResolveReject=null,this.resolve=e=>{const t=this.promiseResolveReject;this.promiseResolveReject=null,null!==t&&t.resolve(e)},this.reject=e=>{const t=this.promiseResolveReject;this.promiseResolveReject=null,null!==t&&t.reject(e)},this.isFulfilled=()=>null===this.promiseResolveReject;const[e,t]=(()=>{let e=null,t=null;const o=new Promise((o,r)=>{e=o,t=r});if(null===e)throw Error("createPromiseValue - resolve is null");if(null===t)throw Error("createPromiseValue - reject is null");return[{resolve:e,reject:t},o]})();this.promiseResolveReject=e,this.promise=t}}const O=async(e,t)=>{console.info(`${e} wait ${t}ms`),await(async e=>new Promise(t=>{setTimeout(t,e)}))(t),console.info(`${e} go forth`)};class F{constructor(e){this.host=e,this.formatLog=e=>`Socket ${this.host} ==> ${e}`}}class z{constructor(e,t){this.eventMessage=new D,this.close=e,this.send=t}static connect(e,t,o){const r=new G,s=new G,n=new WebSocket(t);let i=!1;console.info(e.formatLog("starting ..."));const a=()=>{i||(console.info(e.formatLog("close")),i=!0,r.resolve(null),s.resolve(),n.close())},l=new z(a,e=>{i||n.send(e)});setTimeout(()=>{!1===r.isFulfilled()&&(console.error(e.formatLog(`timeout (${o}ms)`)),a())},o);return n.addEventListener("open",()=>{console.info(e.formatLog("open")),r.resolve(l)}),n.addEventListener("error",t=>{console.error(e.formatLog("error"),t),a()}),n.addEventListener("close",a),n.addEventListener("message",t=>{if(i)return;const o=t.data;"string"!=typeof o?console.error(e.formatLog("onMessage - expected string"),o):l.eventMessage.trigger(o)}),{socket:r.promise,done:s.promise}}static startSocket(e,t,o,r){let s=!0,n=null;const i=new F(e);return(async()=>{for(;s;){const a=z.connect(i,e,t),l=await a.socket;if(null!==l){if(n=l,r({type:"socket",socket:l}),l.eventMessage.on(e=>{r({type:"message",message:e})}),await a.done,r({type:"close"}),!s)return void console.info(i.formatLog("disconnect (1)"));await O(i.formatLog("reconnect after close"),o)}else await O(i.formatLog("reconnect after error"),o)}console.info(i.formatLog("disconnect (2)"))})().catch(e=>{console.error(e)}),{send:e=>{null===n?console.error("send fail - missing connection",e):n.send(e)},dispose:()=>{s=!1,n?.close()}}}}const P=(e,t,o)=>{e.wasm_command({Websocket:{callback:t,message:o}})};class H{constructor(e){this.websocket_register_callback=(e,t)=>{const o=this.getWasm();let r=z.startSocket(e,5e3,3e3,e=>{if(!1!==this.controllerList.has(t)){if("socket"===e.type)return this.socket.set(t,e.socket),void P(o,t,"Connected");if("message"!==e.type)return"close"===e.type?(this.socket.delete(t),void P(o,t,"Disconnected")):(e=>{throw console.error(e),Error("unknown message")})(e);P(o,t,{Message:{message:e.message}})}});this.controllerList.set(t,r)},this.websocket_unregister_callback=e=>{const t=this.controllerList.get(e);void 0!==t?(t.dispose(),this.controllerList.delete(e)):console.error("Expected controller")},this.websocket_send_message=(e,t)=>{const o=this.socket.get(e);void 0===o?console.error(`Missing socket connection for callback_id=${e}`):o.send(t)},this.getWasm=e,this.controllerList=new Map,this.socket=new Map}}const K=e=>{const t={};for(const{k:o,v:r}of e)t[o]=r;return t},q=e=>{if("None"!==e)return JSON.stringify(e.Data.data)},Q=async(e,t,o)=>{const r=e();console.info("fetch request",o);try{const e=await fetch(o.url,{method:o.method,headers:K(o.headers),body:q(o.body)}),s=await(async e=>{const t=e.status,o=e.headers.get("Content-Type");try{return o?.startsWith("text/plain;")?{Ok:{status:t,response:{Text:await e.text()}}}:{Ok:{status:t,response:{Json:await e.json()}}}}catch(e){return{Error:{message:String(e)}}}})(e);r.wasm_command({FetchExecResponse:{response:s,callback:Number(t)}})}catch(e){console.error("fetch error (1)",e);const o={Error:{message:new String(e).toString()}};r.wasm_command({FetchExecResponse:{response:o,callback:Number(t)}})}};class X{constructor(e){this.timerSet=(e,t,o)=>{switch(o){case"Interval":{const o=setInterval(()=>{this.getWasm().wasm_command({TimerCall:{callback:e}})},t);this.data.set(e,{kind:"Interval",timerId:o});break}case"Timeout":{const o=setTimeout(()=>{this.getWasm().wasm_command({TimerCall:{callback:e}})},t);this.data.set(e,{kind:"Timeout",timerId:o});break}}},this.timerClear=e=>{const t=this.data.get(e);if(void 0===t)throw Error("panic");switch(t.kind){case"Interval":clearInterval(t.timerId);break;case"Timeout":clearTimeout(t.timerId)}},this.getWasm=e,this.data=new Map}}class Y{constructor(){this.get=e=>{for(const t of document.cookie.split(";")){if(""===t)continue;const o=t.trim().split("=");if(2!==o.length){console.warn(`Cookies.get: Incorrect number of cookieChunk => ${o.length} in ${t}`);continue}const r=o[0],s=o[1];if(void 0!==r&&void 0!==s){if(r===e)return decodeURIComponent(s)}else console.warn(`Cookies.get: Broken cookie part => ${t}`)}return""},this.get_json=e=>{let t=this.get(e);if(0!==t.length)try{return JSON.parse(t)}catch(e){console.error("Error deserializing cookie",e)}return null},this.set=(e,t,o)=>{const r=null==t?"":encodeURIComponent(t),s=new Date;s.setTime(s.getTime()+1e3*o);let n="expires="+s.toUTCString();document.cookie=`${e}=${r};${n};path=/;samesite=strict"`},this.set_json=(e,t,o)=>{let r=JSON.stringify(t);this.set(e,r,o)}}}const Z=(e,t)=>{const o=t-e+1;return e+Math.floor(Math.random()*o)};class ee{constructor(e,t){this.getWasm=e,this.websocket=new H(e),this.interval=new X(e),this.location=t,this.cookie=new Y}exec(e){const t=e;if("FetchCacheGet"===t)return{data:document.getElementById("v-metadata")?.getAttribute("data-fetch-cache")??null};if("IsBrowser"===t)return{value:!0};if("GetDateNow"===t)return{value:Date.now()};if("TimezoneOffset"===t)return{value:(new Date).getTimezoneOffset()};if("HistoryBack"===t)return window.history.back(),null;if("FetchExec"in t)return Q(this.getWasm,t.FetchExec.callback,t.FetchExec.request),null;if("WebsocketRegister"in t)return this.websocket.websocket_register_callback(t.WebsocketRegister.host,t.WebsocketRegister.callback),null;if("WebsocketSendMessage"in t)return this.websocket.websocket_send_message(t.WebsocketSendMessage.callback,t.WebsocketSendMessage.message),null;if("WebsocketUnregister"in t)return this.websocket.websocket_unregister_callback(t.WebsocketUnregister.callback),null;if("TimerSet"in t)return this.interval.timerSet(t.TimerSet.callback,t.TimerSet.duration,t.TimerSet.kind),null;if("TimerClear"in t)return this.interval.timerClear(t.TimerClear.callback),null;if("LocationGet"in t)return{value:this.location.get(t.LocationGet.target)};if("LocationCallback"in t)return this.location.callback(t.LocationCallback.target,t.LocationCallback.mode,t.LocationCallback.callback),null;if("LocationSet"in t)return this.location.set(t.LocationSet.target,t.LocationSet.mode,t.LocationSet.value),null;if("CookieGet"in t)return{value:this.cookie.get(t.CookieGet.name)};if("CookieSet"in t)return this.cookie.set(t.CookieSet.name,t.CookieSet.value,t.CookieSet.expires_in),null;if("CookieJsonGet"in t)return{value:this.cookie.get_json(t.CookieJsonGet.name)};if("CookieJsonSet"in t)return this.cookie.set_json(t.CookieJsonSet.name,t.CookieJsonSet.value,t.CookieJsonSet.expires_in),null;if("GetEnv"in t){const e=t.GetEnv.name;return{value:document.getElementById("v-metadata")?.getAttribute(`data-env-${e}`)??null}}if("ConsoleLog"in t)switch(t.ConsoleLog.kind){case"Info":return console.info(t.ConsoleLog.message,t.ConsoleLog.arg2,t.ConsoleLog.arg3,t.ConsoleLog.arg4),null;case"Debug":return console.debug(t.ConsoleLog.message,t.ConsoleLog.arg2,t.ConsoleLog.arg3,t.ConsoleLog.arg4),null;case"Error":return console.error(t.ConsoleLog.message,t.ConsoleLog.arg2,t.ConsoleLog.arg3,t.ConsoleLog.arg4),null;case"Log":return console.log(t.ConsoleLog.message,t.ConsoleLog.arg2,t.ConsoleLog.arg3,t.ConsoleLog.arg4),null;case"Warn":return console.warn(t.ConsoleLog.message,t.ConsoleLog.arg2,t.ConsoleLog.arg3,t.ConsoleLog.arg4),null}return"GetRandom"in t?{value:Z(t.GetRandom.min,t.GetRandom.max)}:(console.info("exec_command: Arg",t),g())}}class te{constructor(e){this.trigger=()=>{for(const e of Array.from(this.callback.values()))e()},this.add=e=>{this.callback.set(e,()=>{this.getWasm().wasm_command({LocationCall:{callback:e,value:this.get()}})})},this.remove=e=>{this.callback.delete(e)},this.push=e=>{this.get()!==e&&(location.hash=e,this.trigger())},this.replace=e=>{this.get()!==e&&history.replaceState(null,"",`#${e}`)},this.getWasm=e,this.callback=new Map,window.addEventListener("hashchange",this.trigger)}get(){return decodeURIComponent(location.hash.substr(1))}}class oe{constructor(e){this.trigger=()=>{for(const e of Array.from(this.callback.values()))e()},this.add=e=>{this.callback.set(e,()=>{this.getWasm().wasm_command({LocationCall:{callback:e,value:this.get()}})})},this.remove=e=>{this.callback.delete(e)},this.push=e=>{this.get()!==e&&(window.history.pushState(null,"",e),this.trigger())},this.replace=e=>{this.get()!==e&&(window.history.replaceState(null,"",e),this.trigger())},this.getWasm=e,this.callback=new Map,window.addEventListener("popstate",this.trigger)}get(){return window.location.pathname+window.location.search+window.location.hash}}class re{constructor(e){this.callback=(e,t,o)=>{switch(t){case"Add":return void this.locations[e].add(o);case"Remove":return void this.locations[e].remove(o)}},this.set=(e,t,o)=>{switch(t){case"Push":return void this.locations[e].push(o);case"Replace":return void this.locations[e].replace(o)}},this.get=e=>this.locations[e].get(),this.locations={Hash:new te(e),History:new oe(e)}}}class se{constructor(e){this.wasm=e}vertigo_entry_function(e,t){this.wasm.exports.vertigo_entry_function(e,t)}static async create(e){let t=null;const o=()=>{if(null===t)throw Error("Wasm is no initialized");return t},r=new re(o),s=new J(o,r),n=new ee(o,r);return window.$vertigoApi=s,t=await $(e,{mod:{panic_message:e=>{const t=Number(e%2n**32n),r=Number(e>>32n),s=new TextDecoder("utf-8"),n=o().getUint8Memory().subarray(r,r+t),i=s.decode(n);console.error("PANIC",i)},dom_access:e=>{let t=o().decodeArgumentsLong(e);if(m.isJson(t)){const e=n.exec(t.value);return o().valueSaveToBufferLong({type:f,value:e})}if(Array.isArray(t)){const e=t;let r=new V(s,s.dom.nodes,null);for(const t of e){const o=r.next(e,t);if(null===o)return 0n;r=o}return o().valueSaveToBufferLong(r.toValue())}return console.error("dom_access - wrong parameters",t),0n}}}),new se(t)}}const ne=new Set,ie=async()=>{document.querySelectorAll("*[data-vertigo-run-wasm]").forEach(e=>{const t=e.getAttribute("data-vertigo-run-wasm");"string"==typeof t?(async e=>{if(ne.has(e))return;if(ne.size>0)return void console.error("Only one wasm module can be run",{moduleRun:ne,wasm:e});ne.add(e),console.info(`Wasm module: "${e}" -> start`);const t=await se.create(e);console.info(`Wasm module: "${e}" -> initialized`),t.vertigo_entry_function(0,9),console.info(`Wasm module: "${e}" -> launched vertigo_entry_function with version 0.9`)})(t):console.error("Run error",e)})};window.addEventListener("load",ie),setTimeout(ie,3e3);
//# sourceMappingURL=wasm_run.js.map
